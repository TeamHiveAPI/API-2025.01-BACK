name: Deploy to Azure Windows VM

on:
  push:
    branches:
      - main  # Altere para a branch principal do seu repositório

jobs:
  deploy:
    runs-on: windows-latest  # Runner Windows para o pipeline

    steps:
      # Passo 1: Fazer checkout do código
      - name: Checkout code
        uses: actions/checkout@v4

      # Passo 2: Executar comandos na VM usando Invoke-Command
      - name: Execute commands on VM
        shell: powershell
        run: |
          $username = "${{ secrets.AZURE_VM_USERNAME }}"
          $password = ConvertTo-SecureString "${{ secrets.AZURE_VM_PASSWORD }}" -AsPlainText -Force
          $credential = New-Object System.Management.Automation.PSCredential ($username, $password)

          Set-Item WSMan:\localhost\Client\TrustedHosts -Value "*" -Force

          Invoke-Command -ComputerName ${{ secrets.AZURE_VM_IP }} -Credential $credential -ScriptBlock {
            param($baseDir)

            if (-Not (Test-Path -Path $baseDir)) {
              mkdir $baseDir
            }

            cd $baseDir

            if (-Not (Test-Path -Path "$baseDir\API-2025.01-BACK")) {
              git clone https://github.com/TeamHiveAPI/API-2025.01-BACK.git  API-2025.01-BACK
            } else {
              cd API-2025.01-BACK
              git pull origin main
            }

            cd API-2025.01-BACK

            docker-compose up -d

            Start-Sleep -Seconds 10

            $env:PGPASSWORD = "1234"
            psql -h localhost -U postgres -c "CREATE DATABASE api;"

            python -m venv venv
            .\venv\Scripts\Activate.ps1
            pip install -r requirements.txt
            uvicorn main:app --host 0.0.0.0 --port 8000
          } -ArgumentList "C:\path\to\your\project"